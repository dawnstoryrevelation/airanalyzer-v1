<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Analyzer V1 CNN</title>
    
    <!-- External Libraries: ONNX Runtime for in-browser AI, Chart.js for dynamic graphs -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /*
        ==========================================================================
        ||  GLOBAL STYLES & ROOT CONFIGURATION
        ==========================================================================
        */
        :root {
            --color-beige: #F5F5DC;
            --color-egg-white: #F0EAD6;
            --color-cosmic-black: #0D0D1A;
            --color-celestial-blue: #3A7CA5;
            --color-cerulean-blue: #2A52BE;
            --color-light-gray: #D3D3D3;
            --color-premium-gold: #FFD700;
            --font-primary: 'Helvetica Neue', 'Arial', sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            font-family: var(--font-primary);
            background-color: var(--color-beige);
            color: #333;
            overflow-x: hidden;
        }

        .parallax-container {
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            perspective: 1px;
            -webkit-perspective: 1px;
            transform-style: preserve-3d;
            -webkit-transform-style: preserve-3d;
        }

        .parallax-layer {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform-style: preserve-3d;
            -webkit-transform-style: preserve-3d;
        }

        .parallax-layer-bg {
            transform: translateZ(-1px) scale(2);
            -webkit-transform: translateZ(-1px) scale(2);
        }

        .parallax-layer-base {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        .content-section {
            position: relative;
            padding: 8vh 5vw;
            min-height: 84vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: transparent;
            z-index: 1;
        }

        /*
        ==========================================================================
        ||  HERO SECTION
        ==========================================================================
        */
        #hero {
            background-color: var(--color-beige);
            color: var(--color-cosmic-black);
            overflow: hidden; /* To contain geometric shapes */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #hero h1 {
            font-size: calc(3rem + 3vw);
            font-weight: 900;
            margin: 0;
            animation: fadeIn 1.5s ease-out forwards;
        }

        #hero p {
            font-size: calc(1rem + 1vw);
            margin-top: 20px;
            opacity: 0;
            animation: fadeIn 1.5s ease-out 1s forwards;
        }

        /* Geometric Block Animations */
        .geo-blocks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .block {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.05);
            opacity: 0;
            animation: waft 15s infinite ease-in-out;
        }

        @keyframes waft {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 0.5; }
            90% { transform: translateY(-100vh) translateX(50vw) rotate(360deg); opacity: 0; }
        }

        .block:nth-child(1) { width: 150px; height: 150px; top: 20%; left: 10%; animation-delay: 0s; }
        .block:nth-child(2) { width: 50px; height: 50px; top: 80%; left: 25%; animation-delay: 2s; }
        .block:nth-child(3) { width: 100px; height: 100px; top: 10%; left: 80%; animation-delay: 4s; }
        .block:nth-child(4) { width: 80px; height: 80px; top: 60%; left: 90%; animation-delay: 6s; }
        .block:nth-child(5) { width: 120px; height: 120px; top: 70%; left: 5%; animation-delay: 8s; }


        /*
        ==========================================================================
        ||  HOW IT WORKS SECTION
        ==========================================================================
        */
        #how-it-works {
            background: linear-gradient(to bottom, var(--color-beige), var(--color-egg-white));
        }

        #how-it-works h2, #application h2 {
            font-size: calc(2rem + 2vw);
            font-weight: 700;
            margin-bottom: 40px;
        }

        #how-it-works .content-wrapper {
            max-width: 800px;
            background: rgba(255, 255, 255, 0.5);
            padding: 40px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        #how-it-works p {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 40px;
        }

        .cta-button {
            padding: 15px 35px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            background: var(--color-celestial-blue);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(42, 82, 190, 0.3);
        }

        .cta-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .cta-button:active::before {
            width: 300px;
            height: 300px;
        }
        
        /*
        ==========================================================================
        ||  APPLICATION SECTION
        ==========================================================================
        */
        #application {
            background: var(--color-cosmic-black);
            color: var(--color-light-gray);
            padding-bottom: 50px;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            background: rgba(20, 20, 35, 0.7);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 0 40px rgba(58, 124, 165, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(58, 124, 165, 0.3);
        }
        
        #application.deep-mode .app-container {
            box-shadow: 0 0 60px rgba(150, 200, 255, 0.4);
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
        }

        .mode-btn {
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            background: transparent;
            color: var(--color-light-gray);
            border: 2px solid var(--color-celestial-blue);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active, .mode-btn:hover {
            background: var(--color-celestial-blue);
            color: #fff;
            box-shadow: 0 0 15px rgba(58, 124, 165, 0.5);
        }

        .beta-tag {
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 8px;
            position: relative;
            display: inline-block;
            color: var(--color-premium-gold);
            animation: shimmer 2s infinite linear;
            background: linear-gradient(90deg, #ffd700, #f0e68c, #ffd700);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .app-content { display: none; }
        .app-content.active { display: block; }
        
        .upload-area {
            border: 3px dashed var(--color-celestial-blue);
            border-radius: 15px;
            padding: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            background-color: rgba(58, 124, 165, 0.1);
            border-color: var(--color-light-gray);
        }
        
        #camera-view, #map {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        #camera-video {
            width:100%; height:100%; object-fit: cover; border-radius: 15px;
        }

        .app-button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 1rem;
            background: var(--color-celestial-blue);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .app-button:hover { background: #5a9ac8; }
        .app-button:disabled { background: #555; cursor: not-allowed; }

        .image-preview-container {
            margin-top: 20px;
            max-width: 100%;
            text-align: center;
        }
        #image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            border: 2px solid var(--color-celestial-blue);
        }

        /* --- Results Area --- */
        #results-section {
            display: none;
            margin-top: 40px;
            text-align: left;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .result-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid var(--color-celestial-blue);
        }

        .result-card h3 {
            margin-top: 0;
            color: var(--color-light-gray);
            border-bottom: 1px solid var(--color-celestial-blue);
            padding-bottom: 10px;
        }
        
        #prediction-text, #aqi-text {
            font-size: 1.8rem;
            font-weight: bold;
        }
        #confidence-text {
            font-size: 1.1rem;
            color: #aaa;
        }
        
        /* --- Toggles and Download --- */
        .controls-container {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-switch label {
            cursor: pointer;
        }
        
        .toggle-switch input {
            height: 0;
            width: 0;
            visibility: hidden;
        }
        
        .slider {
            cursor: pointer;
            width: 50px;
            height: 26px;
            background-color: #555;
            border-radius: 26px;
            position: relative;
            transition: background-color 0.2s;
        }
        
        .slider:before {
            content: "";
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.2s;
        }
        
        input:checked + .slider {
            background-color: var(--color-celestial-blue);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* --- Roadmap --- */
        #roadmap-container {
            display: none;
            margin-top: 40px;
            text-align: left;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        
        .roadmap {
            border-left: 3px solid var(--color-celestial-blue);
            padding-left: 30px;
            position: relative;
        }
        
        .roadmap-step {
            margin-bottom: 40px;
            position: relative;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        
        .roadmap-step::before {
            content: '';
            position: absolute;
            left: -40px;
            top: 5px;
            width: 18px;
            height: 18px;
            background-color: var(--color-cosmic-black);
            border: 3px solid var(--color-premium-gold);
            border-radius: 50%;
            z-index: 1;
        }

        .roadmap-step h4 {
            color: var(--color-premium-gold);
            margin: 0 0 10px 0;
            font-size: 1.3rem;
        }
        .roadmap-step p { margin: 0; color: var(--color-light-gray); }

        /*
        ==========================================================================
        ||  CREDITS SECTION
        ==========================================================================
        */
        #credits {
            background-color: var(--color-cosmic-black);
            padding: 50px 0;
            color: var(--color-cerulean-blue);
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        /* Spinner */
        #spinner {
            display: none;
            margin: 20px auto;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--color-celestial-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="parallax-container">
        <!-- Parallax Background Layer -->
        <div class="parallax-layer parallax-layer-bg"></div>

        <!-- Content Layer -->
        <div class="parallax-layer parallax-layer-base">
            
            <!-- HERO SECTION -->
            <header id="hero" class="content-section">
                <div class="geo-blocks">
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                </div>
                <h1>Air Analyzer V1 CNN 7M</h1>
                <p>Show the image, solve the pollution.</p>
            </header>

            <!-- HOW IT WORKS SECTION -->
            <section id="how-it-works" class="content-section">
                <div class="content-wrapper">
                    <h2>How It Works</h2>
                    <p>
                        We have trained an AI model, and for techies, a "Convolutional Neural Network". 
                        Upload an image, take a picture on the spot or even use Google Maps, and Air Analyzer will 
                        accurately calculate the pollution levels of your area based on the image you provide!
                    </p>
                    <a href="#application" class="cta-button">Ready to test it out?</a>
                </div>
            </section>

            <!-- APPLICATION SECTION -->
            <main id="application" class="content-section">
                <div class="app-container">
                    <h2>Application</h2>
                    
                    <div class="mode-selector">
                        <button class="mode-btn active" data-mode="upload">Upload Image</button>
                        <button class="mode-btn" data-mode="camera">Use Camera</button>
                        <button class="mode-btn" data-mode="maps">Google Maps <span class="beta-tag">Beta</span></button>
                    </div>

                    <!-- Mode: Upload Image -->
                    <div id="upload-content" class="app-content active">
                        <div class="upload-area" id="drop-zone">
                            <p>Click to select an image or drag and drop it here.</p>
                            <input type="file" id="file-input" accept="image/*" hidden>
                        </div>
                    </div>
                    
                    <!-- Mode: Use Camera -->
                    <div id="camera-content" class="app-content">
                        <div id="camera-view">
                            <video id="camera-video" autoplay playsinline></video>
                        </div>
                        <button id="capture-btn" class="app-button">Capture & Analyze</button>
                    </div>

                    <!-- Mode: Google Maps -->
                    <div id="maps-content" class="app-content">
                        <div id="map"></div>
                        <button id="analyze-map-btn" class="app-button" disabled>Analyze Street View</button>
                        <p id="map-instructions" style="margin-top: 15px; font-size: 0.9rem;">Navigate the map and enter Street View to enable analysis.</p>
                    </div>

                    <div id="spinner"></div>

                    <div class="image-preview-container">
                        <img id="image-preview" src="" alt="Image Preview" style="display:none;" />
                    </div>

                    <!-- Results Section -->
                    <div id="results-section">
                        <div class="results-grid">
                            <div class="result-card" id="prediction-card">
                                <h3>Prediction</h3>
                                <p id="prediction-text">-</p>
                                <p id="confidence-text">Confidence: -</p>
                            </div>
                            <div class="result-card" id="aqi-card">
                                <h3>AQI Estimate</h3>
                                <p id="aqi-text">-</p>
                            </div>
                            <div class="result-card">
                                <h3>Probability Distribution</h3>
                                <canvas id="prediction-chart"></canvas>
                            </div>
                            <div class="result-card" id="recommendation-card">
                                <h3>Recommendation</h3>
                                <p id="recommendation-text">-</p>
                            </div>
                        </div>

                        <div class="controls-container">
                            <div class="toggle-switch">
                                <span>Display Full Roadmap</span>
                                <label class="switch">
                                    <input type="checkbox" id="roadmap-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="toggle-switch">
                                <span>Deep Mode</span>
                                <label class="switch">
                                    <input type="checkbox" id="deep-mode-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <button id="download-btn" class="app-button">Download Insights</button>
                        </div>
                        
                        <div id="roadmap-container">
                             <h3>Actionable Roadmap to Combat Air Pollution</h3>
                             <div id="roadmap-content" class="roadmap"></div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- CREDITS SECTION -->
            <footer id="credits" class="content-section">
                <p>Collaborators: Eden, Jasper, Vincent, Leon. Thanks!</p>
            </footer>
        </div>
    </div>

    <!-- Google Maps API Script -->
    <!-- IMPORTANT: Replace YOUR_GOOGLE_MAPS_API_KEY with your actual API key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap&libraries=streetView"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // ========================================================================
        // || DOM ELEMENT SELECTORS
        // ========================================================================
        const modeButtons = document.querySelectorAll('.mode-btn');
        const appContents = document.querySelectorAll('.app-content');
        const applicationSection = document.getElementById('application');
        const spinner = document.getElementById('spinner');

        // --- Upload Mode
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        
        // --- Camera Mode
        const cameraView = document.getElementById('camera-view');
        const videoElement = document.getElementById('camera-video');
        const captureBtn = document.getElementById('capture-btn');
        let stream;

        // --- Maps Mode
        const analyzeMapBtn = document.getElementById('analyze-map-btn');

        // --- Common Elements
        const imagePreview = document.getElementById('image-preview');
        const resultsSection = document.getElementById('results-section');
        const predictionText = document.getElementById('prediction-text');
        const confidenceText = document.getElementById('confidence-text');
        const aqiText = document.getElementById('aqi-text');
        const recommendationText = document.getElementById('recommendation-text');
        const downloadBtn = document.getElementById('download-btn');

        // --- Toggles
        const deepModeToggle = document.getElementById('deep-mode-toggle');
        const roadmapToggle = document.getElementById('roadmap-toggle');
        const roadmapContainer = document.getElementById('roadmap-container');
        const roadmapContent = document.getElementById('roadmap-content');
        
        // ========================================================================
        // || CONFIGURATION & STATE
        // ========================================================================
        const MODEL_CONFIG = {
            path: 'air_analyzer_cnn_iden_7m.onnx', // IMPORTANT: This file must be in the same directory.
            imgSize: 224,
            mean: [0.485, 0.456, 0.406],
            std: [0.229, 0.224, 0.225],
            classes: {
                0: "Good ðŸ˜Š",
                1: "Moderate ðŸ™‚", 
                2: "Unhealthy for Sensitive Groups ðŸ˜",
                3: "Unhealthy ðŸ˜•",
                4: "Very Unhealthy ðŸ˜¨",
                5: "Hazardous ðŸ˜·"
            },
            aqiRanges: {
                0: "0-50 AQI", 1: "51-100 AQI", 2: "101-150 AQI",
                3: "151-200 AQI", 4: "201-300 AQI", 5: "300+ AQI"
            }
        };

        let ortSession;
        let predictionChart;
        let lastResults = {};

        // ========================================================================
        // || UI & EVENT LISTENERS
        // ========================================================================

        // --- Mode Switching Logic
        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const mode = button.dataset.mode;
                
                // Update button styles
                modeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Show/hide content sections
                appContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${mode}-content`) {
                        content.classList.add('active');
                    }
                });

                // Handle camera stream
                if (mode === 'camera' && !stream) {
                    startCamera();
                } else if (stream) {
                    stopCamera();
                }
                
                resetUI();
            });
        });

        // --- Deep Mode Toggle
        deepModeToggle.addEventListener('change', (e) => {
            applicationSection.classList.toggle('deep-mode', e.target.checked);
        });
        
        // --- Roadmap Toggle
        roadmapToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                renderRoadmap(lastResults.predicted_class);
                roadmapContainer.style.display = 'block';
                setTimeout(() => {
                    roadmapContainer.style.opacity = 1;
                    const steps = roadmapContent.querySelectorAll('.roadmap-step');
                    steps.forEach((step, index) => {
                        setTimeout(() => {
                            step.style.opacity = 1;
                            step.style.transform = 'translateX(0)';
                        }, index * 200);
                    });
                }, 50);
            } else {
                roadmapContainer.style.opacity = 0;
                setTimeout(() => roadmapContainer.style.display = 'none', 500);
            }
        });


        // --- Upload Mode Listeners
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = 'rgba(58, 124, 165, 0.1)';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.backgroundColor = 'transparent';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = 'transparent';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFile(files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });
        
        // --- Camera Mode Listener
        captureBtn.addEventListener('click', captureAndAnalyze);

        // --- Maps Mode Listener
        analyzeMapBtn.addEventListener('click', analyzeStreetView);
        
        // --- Download Listener
        downloadBtn.addEventListener('click', downloadInsights);

        // ========================================================================
        // || CORE AI/INFERENCE LOGIC
        // ========================================================================

        // --- Load the ONNX model
        async function loadModel() {
            try {
                ortSession = await ort.InferenceSession.create(MODEL_CONFIG.path);
                console.log('ONNX model loaded successfully.');
            } catch (error) {
                console.error('Failed to load ONNX model:', error);
                alert(`Error: Could not load the model file "${MODEL_CONFIG.path}". Ensure it is in the same directory as this HTML file.`);
            }
        }

        // --- Preprocess the image
        async function preprocessImage(imageSource) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = MODEL_CONFIG.imgSize;
            canvas.height = MODEL_CONFIG.imgSize;

            ctx.drawImage(imageSource, 0, 0, MODEL_CONFIG.imgSize, MODEL_CONFIG.imgSize);
            const imageData = ctx.getImageData(0, 0, MODEL_CONFIG.imgSize, MODEL_CONFIG.imgSize);
            
            const { data } = imageData;
            const float32Data = new Float32Array(3 * MODEL_CONFIG.imgSize * MODEL_CONFIG.imgSize);

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i] / 255;
                const g = data[i + 1] / 255;
                const b = data[i + 2] / 255;

                const pixel_index = i / 4;
                const C = 3;
                const H = MODEL_CONFIG.imgSize;
                const W = MODEL_CONFIG.imgSize;
                const y = Math.floor(pixel_index / W);
                const x = pixel_index % W;

                // CHW format
                float32Data[0 * H * W + y * W + x] = (r - MODEL_CONFIG.mean[0]) / MODEL_CONFIG.std[0];
                float32Data[1 * H * W + y * W + x] = (g - MODEL_CONFIG.mean[1]) / MODEL_CONFIG.std[1];
                float32Data[2 * H * W + y * W + x] = (b - MODEL_CONFIG.mean[2]) / MODEL_CONFIG.std[2];
            }
            
            const tensor = new ort.Tensor('float32', float32Data, [1, 3, MODEL_CONFIG.imgSize, MODEL_CONFIG.imgSize]);
            return tensor;
        }
        
        // --- Run inference
        async function runInference(imageSource) {
            if (!ortSession) {
                alert('Model is not loaded yet. Please wait.');
                return;
            }
            
            showSpinner(true);
            resetUI(false); // Soft reset, keep image

            try {
                const tensor = await preprocessImage(imageSource);
                const feeds = { [ortSession.inputNames[0]]: tensor };
                const results = await ortSession.run(feeds);
                const outputTensor = results[ortSession.outputNames[0]];

                postprocessResults(outputTensor.data);
            } catch (error) {
                console.error('Inference failed:', error);
                alert('An error occurred during analysis. Check the console for details.');
            } finally {
                showSpinner(false);
            }
        }
        
        // --- Post-process results and update UI
        function postprocessResults(outputData) {
            const probabilities = softmax(Array.from(outputData));
            const confidence = Math.max(...probabilities);
            const predicted_class = probabilities.indexOf(confidence);

            lastResults = {
                predicted_class,
                confidence,
                probabilities
            };
            
            updateUI(lastResults);
        }

        // ========================================================================
        // || HELPER & MODE-SPECIFIC FUNCTIONS
        // ========================================================================

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                imagePreview.onload = () => runInference(imagePreview);
            };
            reader.readAsDataURL(file);
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera:", err);
                alert("Could not access camera. Please ensure permissions are granted.");
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        function captureAndAnalyze() {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            imagePreview.src = canvas.toDataURL('image/jpeg');
            imagePreview.style.display = 'block';
            runInference(canvas);
        }
        
        function analyzeStreetView() {
            if (window.streetView && window.streetView.pano) {
                // Use the Street View Image API for a clean, static image
                const panoId = window.streetView.pano;
                const heading = window.streetView.pov.heading;
                const pitch = window.streetView.pov.pitch;
                // NOTE: Using the static API requires billing enabled on your Google Cloud project.
                // Replace YOUR_GOOGLE_MAPS_API_KEY with your key.
                const imageUrl = `https://maps.googleapis.com/maps/api/streetview?pano=${panoId}&size=600x400&heading=${heading}&pitch=${pitch}&fov=90&key=AIzaSyD3EHXV7Q3JwlOPS5QPqcbFFbuNs0cMLsg`;

                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    imagePreview.src = img.src;
                    imagePreview.style.display = 'block';
                    runInference(img);
                };
                img.onerror = () => {
                    alert('Could not load Street View image. Ensure your API key is correct and has Street View API enabled.');
                };
                img.src = imageUrl;
            } else {
                alert('No active Street View panorama found.');
            }
        }

        function downloadInsights() {
            if (!lastResults.predicted_class) {
                alert("No analysis data to download.");
                return;
            }
            
            const className = MODEL_CONFIG.classes[lastResults.predicted_class];
            const aqi = MODEL_CONFIG.aqiRanges[lastResults.predicted_class];
            const confidence = (lastResults.confidence * 100).toFixed(2);
            const recommendation = getRecommendation(lastResults.predicted_class).join('\n\n');
            const roadmap = getRoadmapText(lastResults.predicted_class);

            const reportContent = `
Air Analyzer V1 CNN 7M - Analysis Report
=========================================

Date: ${new Date().toLocaleString()}

ANALYSIS RESULTS
----------------
- Classification: ${className}
- Confidence: ${confidence}%
- Estimated AQI Range: ${aqi}

RECOMMENDATION
--------------
${recommendation}

ACTIONABLE ROADMAP
------------------
${roadmap}

PROBABILITY DISTRIBUTION
------------------------
${Object.entries(MODEL_CONFIG.classes).map(([key, value], i) => 
    `- ${value}: ${(lastResults.probabilities[i] * 100).toFixed(2)}%`
).join('\n')}
            `;

            const blob = new Blob([reportContent.trim()], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'AirAnalyzer_Report.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========================================================================
        // || UI UPDATE FUNCTIONS
        // ========================================================================
        
        function updateUI(results) {
            resultsSection.style.display = 'block';
            
            // Prediction & AQI
            const { predicted_class, confidence, probabilities } = results;
            predictionText.textContent = MODEL_CONFIG.classes[predicted_class];
            confidenceText.textContent = `Confidence: ${(confidence * 100).toFixed(2)}%`;
            aqiText.textContent = MODEL_CONFIG.aqiRanges[predicted_class];
            
            // Recommendation
            const recommendation = getRecommendation(predicted_class);
            recommendationText.innerHTML = `<strong>${recommendation[0]}</strong><br>${recommendation[1]}<br><br><em>${recommendation[2]}</em>`;
            
            // Chart
            updateChart(probabilities);
            
            // Update card colors based on severity
            const severityColor = getSeverityColor(predicted_class);
            document.getElementById('prediction-card').style.borderColor = severityColor;
            document.getElementById('aqi-card').style.borderColor = severityColor;
            
            // Reset and handle roadmap
            roadmapToggle.checked = false;
            roadmapContainer.style.opacity = 0;
            roadmapContainer.style.display = 'none';
        }

        function updateChart(probabilities) {
            const labels = Object.values(MODEL_CONFIG.classes).map(c => c.split(' ')[0]);
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Pollution Class Probability',
                    data: probabilities.map(p => p * 100),
                    backgroundColor: labels.map((_, i) => getSeverityColor(i)),
                    borderColor: 'rgba(255, 255, 255, 0.5)',
                    borderWidth: 1
                }]
            };

            if (predictionChart) {
                predictionChart.data = data;
                predictionChart.update();
            } else {
                const ctx = document.getElementById('prediction-chart').getContext('2d');
                predictionChart = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                beginAtZero: true, max: 100,
                                ticks: { color: '#aaa', callback: value => value + '%' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y: { ticks: { color: '#ddd' }, grid: { display: false } }
                        }
                    }
                });
            }
        }
        
        function renderRoadmap(predicted_class) {
            let steps = [];
            const baseSteps = [
                { title: "Immediate Actions", text: "Wear a high-quality mask (N95/P2) outdoors. Use air purifiers indoors and keep windows closed." },
                { title: "Community Engagement", text: "Advocate for local policies promoting green spaces, better public transport, and stricter industrial emission controls." },
                { title: "Personal Contribution", text: "Reduce your carbon footprint: use public transport, bike or walk. Consolidate trips. Reduce energy consumption at home." },
                { title: "Long-Term Vision", text: "Support and invest in renewable energy sources. Promote sustainable urban planning and circular economy principles in your community." }
            ];

            switch(predicted_class) {
                case 5: // Hazardous
                    steps.push({ title: "URGENT HEALTH WARNING", text: "This is a health emergency. Avoid all outdoor activity. Seek medical advice if you experience respiratory symptoms." });
                    steps = steps.concat(baseSteps);
                    break;
                case 4: // Very Unhealthy
                    steps.push({ title: "High Alert", text: "Significantly limit outdoor exposure, especially for sensitive groups. All outdoor exertion should be avoided." });
                    steps = steps.concat(baseSteps);
                    break;
                case 3: // Unhealthy
                    steps.push({ title: "Health Advisory", text: "Sensitive groups should avoid all outdoor exertion. Everyone else should limit prolonged outdoor activity." });
                    steps = steps.concat(baseSteps.slice(1));
                    break;
                case 2: // Unhealthy for Sensitive
                    steps.push({ title: "Precautionary Measures", text: "People with heart or lung disease, older adults, and children should reduce prolonged or heavy exertion outdoors." });
                    steps = steps.concat(baseSteps.slice(2));
                    break;
                default: // Good / Moderate
                    steps.push({ title: "Maintain & Improve", text: "Air quality is good, but proactive measures are key. Focus on sustainable habits to keep it this way." });
                    steps = steps.concat(baseSteps.slice(2));
            }
            
            roadmapContent.innerHTML = steps.map(step => `
                <div class="roadmap-step">
                    <h4>${step.title}</h4>
                    <p>${step.text}</p>
                </div>
            `).join('');
        }

        function resetUI(fullReset = true) {
            resultsSection.style.display = 'none';
            if (fullReset) {
                imagePreview.style.display = 'none';
                imagePreview.src = "";
            }
            lastResults = {};
            roadmapToggle.checked = false;
            roadmapContainer.style.display = 'none';
        }
        
        function showSpinner(show) {
            spinner.style.display = show ? 'block' : 'none';
        }
        
        function getRecommendation(level) {
            // [WHAT, HOW, WHY]
            switch(level) {
                case 5: return ["SEEK CLEAN AIR IMMEDIATELY", "Stay indoors in a well-sealed, air-purified space. Wear an N95 or P100 respirator if you must go out.", "Hazardous air poses a serious, immediate risk of severe health effects for everyone."];
                case 4: return ["AVOID OUTDOOR ACTIVITY", "Postpone all outdoor plans. Keep indoor air clean with purifiers and closed windows.", "Very unhealthy air significantly increases the risk of respiratory and cardiovascular issues for all individuals."];
                case 3: return ["LIMIT OUTDOOR EXPOSURE", "Reduce time spent outdoors, especially strenuous activities. Sensitive groups should remain indoors.", "Unhealthy air can aggravate lung and heart conditions and cause irritation even in healthy individuals."];
                case 2: return ["BE CAUTIOUS", "If you're in a sensitive group (e.g., have asthma, are elderly), limit prolonged outdoor exertion.", "Even at this level, pollution can trigger health problems for vulnerable populations."];
                case 1: return ["ENJOY THE AIR MINDFULLY", "It's a good day for outdoor activities. Consider walking or biking instead of driving to help keep it this way.", "Maintaining good air quality requires continuous collective effort, and your choices matter."];
                default: return ["APPRECIATE THE CLEAN AIR", "This is the ideal air quality for all outdoor activities. Take action to preserve it.", "Protecting clean air is easier than cleaning polluted air. Support green initiatives and sustainable practices."];
            }
        }
        
        function getRoadmapText(level) {
            // A simplified text version for the download
            const roadmapDiv = document.createElement('div');
            renderRoadmap(level); // Renders into the hidden #roadmap-content
            return Array.from(roadmapContent.children).map(step => {
                const title = step.querySelector('h4').textContent;
                const text = step.querySelector('p').textContent;
                return `- ${title}:\n  ${text}`;
            }).join('\n\n');
        }

        function getSeverityColor(level) {
            const colors = ['#4CAF50', '#FFC107', '#FF9800', '#F44336', '#9C27B0', '#673AB7'];
            return colors[level] || '#777';
        }
        
        function softmax(arr) {
            const maxLog = Math.max(...arr);
            const exps = arr.map(x => Math.exp(x - maxLog));
            const sumExps = exps.reduce((a, b) => a + b);
            return exps.map(x => x / sumExps);
        }

        // ========================================================================
        // || INITIALIZATION
        // ========================================================================
        loadModel();
    });

    // ========================================================================
    // || GOOGLE MAPS API CALLBACK
    // ========================================================================
    let map, panorama;
    window.streetView = null; // Global handle for street view state

    function initMap() {
        const initialLocation = { lat: 40.7291, lng: -73.9965 }; // NYC
        map = new google.maps.Map(document.getElementById("map"), {
            center: initialLocation,
            zoom: 14,
            streetViewControl: true,
        });

        panorama = map.getStreetView();
        panorama.setPosition(initialLocation);
        
        panorama.addListener("visible_changed", () => {
            document.getElementById('analyze-map-btn').disabled = !panorama.getVisible();
        });
        
        panorama.addListener("pano_changed", () => {
            window.streetView = { pano: panorama.getPano(), pov: panorama.getPov() };
        });
        
        panorama.addListener("pov_changed", () => {
             window.streetView = { pano: panorama.getPano(), pov: panorama.getPov() };
        });
    }

    </script>
</body>
</html>